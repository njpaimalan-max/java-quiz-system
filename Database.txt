package quizsystem;

import java.sql.*;

public class Database {

    private static final String URL_ROOT = "jdbc:mysql://localhost:3306/";
    private static final String URL_DB = "jdbc:mysql://localhost:3306/quiz_db";
    private static final String USER = "root";
    private static final String PASS = "";

    public static Connection getConnection() {
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
            System.out.println("MySQL Driver loaded successfully");

            Connection rootConn = DriverManager.getConnection(URL_ROOT, USER, PASS);
            Statement st = rootConn.createStatement();
            st.execute("CREATE DATABASE IF NOT EXISTS quiz_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
            rootConn.close();
            System.out.println("Database 'quiz_db' created/verified");

            Connection dbConn = DriverManager.getConnection(URL_DB, USER, PASS);
            System.out.println("Connected to database successfully");

            createTables(dbConn);

            return dbConn;

        } catch (Exception e) {
            System.err.println("ERROR connecting to database:");
            e.printStackTrace();
            return null;
        }
    }

    private static void createTables(Connection conn) throws SQLException {
        Statement st = conn.createStatement();

        System.out.println("\n=== Creating Tables ===");

        st.execute("""
            CREATE TABLE IF NOT EXISTS users (
                id INT AUTO_INCREMENT PRIMARY KEY,
                username VARCHAR(50) UNIQUE NOT NULL,
                password VARCHAR(50) NOT NULL,
                role VARCHAR(10) NOT NULL,
                section VARCHAR(20) DEFAULT ''
            )
        """);
        System.out.println("✓ Created 'users' table");

        st.execute("""
            CREATE TABLE IF NOT EXISTS questions (
                id INT AUTO_INCREMENT PRIMARY KEY,
                question TEXT NOT NULL,
                choiceA VARCHAR(255) NOT NULL,
                choiceB VARCHAR(255) NOT NULL,
                choiceC VARCHAR(255),
                choiceD VARCHAR(255),
                correct VARCHAR(10) NOT NULL,
                type VARCHAR(20) DEFAULT 'MCQ',
                points INT DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """);
        System.out.println("✓ Created 'questions' table");

        st.execute("""
            CREATE TABLE IF NOT EXISTS scores (
                id INT AUTO_INCREMENT PRIMARY KEY,
                student VARCHAR(50) NOT NULL,
                subject VARCHAR(100) DEFAULT 'General Quiz',
                score INT DEFAULT 0,
                total INT DEFAULT 0,
                percentage DECIMAL(5,2) DEFAULT 0,
                grade VARCHAR(5),
                time_taken INT DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """);
        System.out.println("✓ Created 'scores' table");

        insertDefaultData(conn);

        System.out.println("=== All tables created successfully ===\n");
    }

    private static void insertDefaultData(Connection conn) throws SQLException {
        try {
            PreparedStatement checkAdmin = conn.prepareStatement(
                    "SELECT COUNT(*) as count FROM users WHERE username='admin'");
            ResultSet rs = checkAdmin.executeQuery();

            if (rs.next() && rs.getInt("count") == 0) {
                PreparedStatement insertAdmin = conn.prepareStatement(
                        "INSERT INTO users(username, password, role, section) VALUES(?, ?, ?, ?)");
                insertAdmin.setString(1, "admin");
                insertAdmin.setString(2, "admin123");
                insertAdmin.setString(3, "admin");
                insertAdmin.setString(4, "");
                insertAdmin.executeUpdate();
                System.out.println("✓ Created default admin: username='admin', password='admin123'");
            }
        } catch (SQLException e) {
            System.out.println("Note: Admin user may already exist");
        }

        try {
            PreparedStatement checkQuestions = conn.prepareStatement(
                    "SELECT COUNT(*) FROM questions");
            ResultSet rs = checkQuestions.executeQuery();

            if (rs.next() && rs.getInt(1) == 0) {
                System.out.println("Inserting sample questions...");

                String[][] sampleQuestions = {
                        {
                                "What is the capital of France?",
                                "London", "Berlin", "Paris", "Madrid",
                                "C", "MCQ", "1"
                        },
                        {
                                "Which planet is known as the Red Planet?",
                                "Earth", "Mars", "Jupiter", "Saturn",
                                "B", "MCQ", "1"
                        },
                        {
                                "Who painted the Mona Lisa?",
                                "Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Michelangelo",
                                "C", "MCQ", "1"
                        },
                        {
                                "What is the largest mammal in the world?",
                                "African Elephant", "Blue Whale", "Giraffe", "Polar Bear",
                                "B", "MCQ", "1"
                        },
                        {
                                "How many continents are there?",
                                "5", "6", "7", "8",
                                "C", "MCQ", "1"
                        }
                };

                for (String[] q : sampleQuestions) {
                    PreparedStatement ps = conn.prepareStatement("""
                        INSERT INTO questions(question, choiceA, choiceB, choiceC, choiceD, correct, type, points)
                        VALUES(?, ?, ?, ?, ?, ?, ?, ?)
                    """);

                    ps.setString(1, q[0]);
                    ps.setString(2, q[1]);
                    ps.setString(3, q[2]);
                    ps.setString(4, q[3]);
                    ps.setString(5, q[4]);
                    ps.setString(6, q[5]);
                    ps.setString(7, q[6]);
                    ps.setInt(8, Integer.parseInt(q[7]));

                    ps.executeUpdate();
                }
                System.out.println("✓ Inserted 5 sample questions");
            }
        } catch (SQLException e) {
            System.out.println("Note: Questions may already exist");
        }
    }

    public static void fixMissingTables(Connection conn) {
        try {
            System.out.println("Checking and fixing database structure...");

            addColumnIfMissing(conn, "scores", "created_at", "TIMESTAMP DEFAULT CURRENT_TIMESTAMP");
            addColumnIfMissing(conn, "scores", "subject", "VARCHAR(100) DEFAULT 'General Quiz'");
            addColumnIfMissing(conn, "scores", "percentage", "DECIMAL(5,2) DEFAULT 0");
            addColumnIfMissing(conn, "scores", "grade", "VARCHAR(5)");
            addColumnIfMissing(conn, "scores", "time_taken", "INT DEFAULT 0");

            addColumnIfMissing(conn, "questions", "created_at", "TIMESTAMP DEFAULT CURRENT_TIMESTAMP");
            addColumnIfMissing(conn, "questions", "type", "VARCHAR(20) DEFAULT 'MCQ'");
            addColumnIfMissing(conn, "questions", "points", "INT DEFAULT 1");

            System.out.println("✓ Database structure verified");

        } catch (SQLException e) {
            System.err.println("Error fixing tables: " + e.getMessage());
        }
    }

    private static void addColumnIfMissing(Connection conn, String table, String column, String definition)
            throws SQLException {
        DatabaseMetaData meta = conn.getMetaData();
        ResultSet columns = meta.getColumns(null, null, table, column);

        if (!columns.next()) {
            Statement st = conn.createStatement();
            try {
                st.execute("ALTER TABLE " + table + " ADD COLUMN " + column + " " + definition);
                System.out.println("  Added column '" + column + "' to table '" + table + "'");
            } catch (SQLException e) {
                System.out.println("  Note: Column '" + column + "' already exists or error: " + e.getMessage());
            }
        }
    }
}