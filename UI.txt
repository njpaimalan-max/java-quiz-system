package quizsystem;

import quizsystem.Models.*;
        import javax.swing.*;
        import javax.swing.table.DefaultTableModel;
import java.awt.*;
        import java.sql.*;
        import java.util.ArrayList;
import java.util.Collections;

public class UI extends JFrame {

    Connection conn;
    CardLayout card;
    JPanel mainPanel;

    User loggedUser;
    ArrayList<Question> quizQuestions;
    int currentIndex = 0;
    int score = 0;
    int totalPoints = 0;
    Timer quizTimer;
    int timeLeft = 60;


    String currentSubject = "General Quiz";


    JTable questionTable;


    JLabel qText;
    JRadioButton optA, optB, optC, optD;
    ButtonGroup group;
    JLabel timerLabel;


    JTextField loginUserField;
    JPasswordField loginPassField;


    JTextField regUserField;
    JPasswordField regPassField;
    JTextField regSectionField;

    public UI() {
        conn = Database.getConnection();


        try {
            Database.fixMissingTables(conn);
        } catch (Exception e) {
            System.out.println("Note: Tables already exist or error fixing: " + e.getMessage());
        }

        card = new CardLayout();
        mainPanel = new JPanel(card);


        mainPanel.add(createLoginPanel(), "login");
        mainPanel.add(createRegisterPanel(), "register");
        mainPanel.add(createAdminPanel(), "admin");
        mainPanel.add(createStudentPanel(), "student");
        mainPanel.add(createQuizPanel(), "quiz");

        add(mainPanel);
        setTitle("Java Quiz Bank System");
        setSize(900, 600);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        setVisible(true);
    }



    private JPanel createLoginPanel() {
        JPanel p = new JPanel(null);
        p.setBackground(new Color(240, 248, 255));

        JLabel title = new JLabel("QUIZ SYSTEM LOGIN");
        title.setFont(new Font("Arial", Font.BOLD, 24));
        title.setBounds(350, 50, 300, 40);
        p.add(title);

        JLabel u = new JLabel("Username:");
        u.setBounds(300, 150, 100, 30);
        u.setFont(new Font("Arial", Font.PLAIN, 14));

        loginUserField = new JTextField();
        loginUserField.setBounds(400, 150, 200, 30);

        JLabel pw = new JLabel("Password:");
        pw.setBounds(300, 200, 100, 30);
        pw.setFont(new Font("Arial", Font.PLAIN, 14));

        loginPassField = new JPasswordField();
        loginPassField.setBounds(400, 200, 200, 30);

        JButton loginBtn = new JButton("Login");
        loginBtn.setBounds(400, 260, 200, 35);
        loginBtn.setBackground(new Color(70, 130, 180));
        loginBtn.setForeground(Color.WHITE);
        loginBtn.setFont(new Font("Arial", Font.BOLD, 14));

        JButton regBtn = new JButton("Register New Student");
        regBtn.setBounds(400, 310, 200, 35);
        regBtn.setBackground(new Color(46, 139, 87));
        regBtn.setForeground(Color.WHITE);

        loginBtn.addActionListener(e -> {
            String username = loginUserField.getText().trim();
            String password = new String(loginPassField.getPassword()).trim();
            if (username.isEmpty() || password.isEmpty()) {
                JOptionPane.showMessageDialog(this, "Please enter both username and password!");
                return;
            }
            login(username, password);
        });

        regBtn.addActionListener(e -> {
            loginUserField.setText("");
            loginPassField.setText("");
            card.show(mainPanel, "register");
        });

        p.add(u); p.add(loginUserField);
        p.add(pw); p.add(loginPassField);
        p.add(loginBtn);
        p.add(regBtn);

        return p;
    }

    private void login(String user, String pass) {
        try {
            PreparedStatement ps = conn.prepareStatement(
                    "SELECT * FROM users WHERE username=? AND password=?");
            ps.setString(1, user);
            ps.setString(2, pass);
            ResultSet rs = ps.executeQuery();

            if (rs.next()) {
                String role = rs.getString("role");
                String section = rs.getString("section");

                if (role.equals("admin")) {
                    loggedUser = new Admin(user, pass);
                    card.show(mainPanel, "admin");
                    loadQuestions();
                } else {
                    loggedUser = new Student(user, pass, section);
                    card.show(mainPanel, "student");
                }

                loginUserField.setText("");
                loginPassField.setText("");

                JOptionPane.showMessageDialog(this, "Login successful! Welcome " + user);
            } else {
                JOptionPane.showMessageDialog(this, "Invalid username or password!");
            }
        } catch (Exception ex) {
            JOptionPane.showMessageDialog(this, "Error during login: " + ex.getMessage());
            ex.printStackTrace();
        }
    }

    private JPanel createRegisterPanel() {
        JPanel p = new JPanel(null);
        p.setBackground(new Color(240, 248, 255));

        JLabel title = new JLabel("STUDENT REGISTRATION");
        title.setFont(new Font("Arial", Font.BOLD, 24));
        title.setBounds(320, 50, 300, 40);
        p.add(title);

        JLabel u = new JLabel("Username:");
        u.setBounds(300, 130, 150, 30);
        u.setFont(new Font("Arial", Font.PLAIN, 14));

        regUserField = new JTextField();
        regUserField.setBounds(450, 130, 200, 30);

        JLabel pw = new JLabel("Password:");
        pw.setBounds(300, 180, 150, 30);
        pw.setFont(new Font("Arial", Font.PLAIN, 14));

        regPassField = new JPasswordField();
        regPassField.setBounds(450, 180, 200, 30);

        JLabel sec = new JLabel("Section:");
        sec.setBounds(300, 230, 150, 30);
        sec.setFont(new Font("Arial", Font.PLAIN, 14));

        regSectionField = new JTextField();
        regSectionField.setBounds(450, 230, 200, 30);

        JButton regBtn = new JButton("Register");
        regBtn.setBounds(450, 290, 200, 35);
        regBtn.setBackground(new Color(46, 139, 87));
        regBtn.setForeground(Color.WHITE);
        regBtn.setFont(new Font("Arial", Font.BOLD, 14));

        JButton backBtn = new JButton("Back to Login");
        backBtn.setBounds(450, 340, 200, 35);
        backBtn.setBackground(new Color(105, 105, 105));
        backBtn.setForeground(Color.WHITE);

        regBtn.addActionListener(e -> {
            String uname = regUserField.getText().trim();
            String pass = new String(regPassField.getPassword()).trim();
            String secVal = regSectionField.getText().trim();

            if(uname.isEmpty() || pass.isEmpty() || secVal.isEmpty()){
                JOptionPane.showMessageDialog(this, "Please fill all fields!");
                return;
            }

            if(pass.length() < 4) {
                JOptionPane.showMessageDialog(this, "Password must be at least 4 characters!");
                return;
            }

            try {
                PreparedStatement check = conn.prepareStatement(
                        "SELECT * FROM users WHERE username=?");
                check.setString(1, uname);
                ResultSet rs = check.executeQuery();

                if(rs.next()){
                    JOptionPane.showMessageDialog(this, "Username already exists!");
                    return;
                }

                PreparedStatement ps = conn.prepareStatement("""
                    INSERT INTO users(username, password, role, section)
                    VALUES(?, ?, ?, ?)
                """);

                ps.setString(1, uname);
                ps.setString(2, pass);
                ps.setString(3, "student");
                ps.setString(4, secVal);
                ps.executeUpdate();

                JOptionPane.showMessageDialog(this,
                        "Registration Successful!\nYou can now login with your credentials.");

                regUserField.setText("");
                regPassField.setText("");
                regSectionField.setText("");
                card.show(mainPanel, "login");

            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Registration error: " + ex.getMessage());
                ex.printStackTrace();
            }
        });

        backBtn.addActionListener(e -> {
            regUserField.setText("");
            regPassField.setText("");
            regSectionField.setText("");
            card.show(mainPanel, "login");
        });

        p.add(u); p.add(regUserField);
        p.add(pw); p.add(regPassField);
        p.add(sec); p.add(regSectionField);
        p.add(regBtn); p.add(backBtn);

        return p;
    }

    private JPanel createAdminPanel() {
        JPanel p = new JPanel(null);
        p.setBackground(new Color(245, 245, 245));

        JLabel title = new JLabel("ADMIN DASHBOARD - Question Management");
        title.setFont(new Font("Arial", Font.BOLD, 20));
        title.setBounds(20, 20, 500, 30);
        p.add(title);

        JLabel userInfo = new JLabel("Logged in as: " + (loggedUser != null ? loggedUser.getUsername() : ""));
        userInfo.setBounds(20, 60, 300, 25);
        p.add(userInfo);

        JButton logout = new JButton("Logout");
        logout.setBounds(700, 20, 150, 30);
        logout.setBackground(new Color(220, 20, 60));
        logout.setForeground(Color.WHITE);
        logout.addActionListener(e -> {
            loggedUser = null;
            card.show(mainPanel, "login");
        });
        p.add(logout);

        JButton exit = new JButton("Exit System");
        exit.setBounds(700, 60, 150, 30);
        exit.addActionListener(e -> System.exit(0));
        p.add(exit);

        questionTable = new JTable();
        questionTable.setFont(new Font("Arial", Font.PLAIN, 12));
        questionTable.setRowHeight(25);
        JScrollPane sp = new JScrollPane(questionTable);
        sp.setBounds(20, 100, 850, 300);
        p.add(sp);

        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 10, 0));
        buttonPanel.setBounds(20, 420, 850, 40);
        buttonPanel.setBackground(new Color(245, 245, 245));

        JButton addBtn = new JButton("âž• Add New Question");
        JButton editBtn = new JButton("âœï¸ Edit Question");
        JButton deleteBtn = new JButton("ðŸ—‘ï¸ Delete Question");
        JButton refreshBtn = new JButton("ðŸ”„ Refresh");
        JButton viewScoresBtn = new JButton("ðŸ“Š View Scores");
        JButton manageSubjectsBtn = new JButton("ðŸ“š Manage Subjects");

        addBtn.setBackground(new Color(70, 130, 180));
        editBtn.setBackground(new Color(255, 165, 0));
        deleteBtn.setBackground(new Color(220, 20, 60));
        refreshBtn.setBackground(new Color(46, 139, 87));
        viewScoresBtn.setBackground(new Color(138, 43, 226));
        manageSubjectsBtn.setBackground(new Color(139, 0, 139));

        addBtn.setForeground(Color.WHITE);
        editBtn.setForeground(Color.WHITE);
        deleteBtn.setForeground(Color.WHITE);
        refreshBtn.setForeground(Color.WHITE);
        viewScoresBtn.setForeground(Color.WHITE);
        manageSubjectsBtn.setForeground(Color.WHITE);

        buttonPanel.add(addBtn);
        buttonPanel.add(editBtn);
        buttonPanel.add(deleteBtn);
        buttonPanel.add(refreshBtn);
        buttonPanel.add(viewScoresBtn);
        buttonPanel.add(manageSubjectsBtn);

        p.add(buttonPanel);

        refreshBtn.addActionListener(e -> loadQuestions());
        addBtn.addActionListener(e -> addQuestionDialog());
        editBtn.addActionListener(e -> editQuestionDialog());
        deleteBtn.addActionListener(e -> deleteQuestion());
        viewScoresBtn.addActionListener(e -> viewScoresDialog());
        manageSubjectsBtn.addActionListener(e -> manageSubjectsDialog());

        loadQuestions();
        return p;
    }

    private void loadQuestions() {
        try {
            DefaultTableModel model = new DefaultTableModel(
                    new String[]{"ID", "Question", "Choice A", "Choice B",
                            "Choice C", "Choice D", "Correct", "Type", "Points"}, 0) {
                @Override
                public boolean isCellEditable(int row, int column) {
                    return false;
                }
            };

            Statement st = conn.createStatement();
            ResultSet rs = st.executeQuery("SELECT * FROM questions ORDER BY id");

            while (rs.next()) {
                model.addRow(new Object[]{
                        rs.getInt("id"),
                        rs.getString("question"),
                        rs.getString("choiceA"),
                        rs.getString("choiceB"),
                        rs.getString("choiceC"),
                        rs.getString("choiceD"),
                        rs.getString("correct"),
                        rs.getString("type"),
                        rs.getInt("points")
                });
            }
            questionTable.setModel(model);

            questionTable.getColumnModel().getColumn(0).setPreferredWidth(50);
            questionTable.getColumnModel().getColumn(1).setPreferredWidth(300);
            for (int i = 2; i <= 5; i++) {
                questionTable.getColumnModel().getColumn(i).setPreferredWidth(150);
            }

        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error loading questions: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void addQuestionDialog() {
        JPanel panel = new JPanel(new GridLayout(10, 2, 10, 10));

        JTextField subjectField = new JTextField("General Quiz");

        JTextField questionField = new JTextField();
        JTextField aField = new JTextField();
        JTextField bField = new JTextField();
        JTextField cField = new JTextField();
        JTextField dField = new JTextField();
        JTextField correctField = new JTextField();
        JTextField typeField = new JTextField("MCQ");
        JTextField pointsField = new JTextField("1");

        panel.add(new JLabel("Subject:"));
        panel.add(subjectField);
        panel.add(new JLabel("Question Text:"));
        panel.add(questionField);
        panel.add(new JLabel("Choice A:"));
        panel.add(aField);
        panel.add(new JLabel("Choice B:"));
        panel.add(bField);
        panel.add(new JLabel("Choice C:"));
        panel.add(cField);
        panel.add(new JLabel("Choice D:"));
        panel.add(dField);
        panel.add(new JLabel("Correct Answer (A/B/C/D):"));
        panel.add(correctField);
        panel.add(new JLabel("Type (MCQ/ID):"));
        panel.add(typeField);
        panel.add(new JLabel("Points:"));
        panel.add(pointsField);

        int result = JOptionPane.showConfirmDialog(this, panel,
                "Add New Question", JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

        if (result == JOptionPane.OK_OPTION) {
            if (questionField.getText().trim().isEmpty() || aField.getText().trim().isEmpty() ||
                    bField.getText().trim().isEmpty() || correctField.getText().trim().isEmpty()) {
                JOptionPane.showMessageDialog(this, "Please fill all required fields!");
                return;
            }

            try {
                PreparedStatement ps = conn.prepareStatement("""
                INSERT INTO questions(question, choiceA, choiceB, choiceC, choiceD, correct, type, points)
                VALUES(?, ?, ?, ?, ?, ?, ?, ?)
            """);

                ps.setString(1, questionField.getText().trim());
                ps.setString(2, aField.getText().trim());
                ps.setString(3, bField.getText().trim());
                ps.setString(4, cField.getText().trim());
                ps.setString(5, dField.getText().trim());
                ps.setString(6, correctField.getText().trim().toUpperCase());
                ps.setString(7, typeField.getText().trim());

                try {
                    ps.setInt(8, Integer.parseInt(pointsField.getText().trim()));
                } catch (NumberFormatException e) {
                    ps.setInt(8, 1);
                }

                ps.executeUpdate();

                loadQuestions();
                JOptionPane.showMessageDialog(this, "Question added successfully!");
            } catch (Exception e) {
                JOptionPane.showMessageDialog(this, "Error adding question: " + e.getMessage());
                e.printStackTrace();
            }
        }
    }

    private void editQuestionDialog() {
        int row = questionTable.getSelectedRow();
        if (row == -1) {
            JOptionPane.showMessageDialog(this, "Please select a question to edit!");
            return;
        }

        int questionId = (int) questionTable.getValueAt(row, 0);

        try {
            PreparedStatement ps = conn.prepareStatement(
                    "SELECT * FROM questions WHERE id = ?");
            ps.setInt(1, questionId);
            ResultSet rs = ps.executeQuery();

            if (!rs.next()) {
                JOptionPane.showMessageDialog(this, "Question not found!");
                return;
            }

            JPanel panel = new JPanel(new GridLayout(9, 2, 10, 10));

            JTextField q = new JTextField(rs.getString("question"));
            JTextField a = new JTextField(rs.getString("choiceA"));
            JTextField b = new JTextField(rs.getString("choiceB"));
            JTextField c = new JTextField(rs.getString("choiceC"));
            JTextField d = new JTextField(rs.getString("choiceD"));
            JTextField correct = new JTextField(rs.getString("correct"));
            JTextField type = new JTextField(rs.getString("type"));
            JTextField points = new JTextField(String.valueOf(rs.getInt("points")));

            panel.add(new JLabel("Question Text:"));
            panel.add(q);
            panel.add(new JLabel("Choice A:"));
            panel.add(a);
            panel.add(new JLabel("Choice B:"));
            panel.add(b);
            panel.add(new JLabel("Choice C:"));
            panel.add(c);
            panel.add(new JLabel("Choice D:"));
            panel.add(d);
            panel.add(new JLabel("Correct Answer (A/B/C/D):"));
            panel.add(correct);
            panel.add(new JLabel("Type (MCQ/ID):"));
            panel.add(type);
            panel.add(new JLabel("Points:"));
            panel.add(points);

            int result = JOptionPane.showConfirmDialog(this, panel,
                    "Edit Question (ID: " + questionId + ")",
                    JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);

            if (result == JOptionPane.OK_OPTION) {
                PreparedStatement updatePs = conn.prepareStatement("""
                    UPDATE questions 
                    SET question = ?, choiceA = ?, choiceB = ?, choiceC = ?, choiceD = ?,
                        correct = ?, type = ?, points = ?
                    WHERE id = ?
                """);

                updatePs.setString(1, q.getText().trim());
                updatePs.setString(2, a.getText().trim());
                updatePs.setString(3, b.getText().trim());
                updatePs.setString(4, c.getText().trim());
                updatePs.setString(5, d.getText().trim());
                updatePs.setString(6, correct.getText().trim().toUpperCase());
                updatePs.setString(7, type.getText().trim());
                updatePs.setInt(8, Integer.parseInt(points.getText().isEmpty() ? "1" : points.getText()));
                updatePs.setInt(9, questionId);

                updatePs.executeUpdate();

                loadQuestions();
                JOptionPane.showMessageDialog(this, "Question updated successfully!");
            }

        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error editing question: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void deleteQuestion() {
        int row = questionTable.getSelectedRow();
        if (row == -1) {
            JOptionPane.showMessageDialog(this, "Please select a question to delete!");
            return;
        }

        int id = (int) questionTable.getValueAt(row, 0);
        int confirm = JOptionPane.showConfirmDialog(this,
                "Are you sure you want to delete this question?", "Confirm Delete",
                JOptionPane.YES_NO_OPTION);

        if (confirm == JOptionPane.YES_OPTION) {
            try {
                PreparedStatement ps = conn.prepareStatement(
                        "DELETE FROM questions WHERE id = ?");
                ps.setInt(1, id);
                ps.executeUpdate();
                loadQuestions();
                JOptionPane.showMessageDialog(this, "Question deleted successfully!");
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Error deleting question!");
                ex.printStackTrace();
            }
        }
    }

    private void viewScoresDialog() {
        try {
            DefaultTableModel model = new DefaultTableModel(
                    new String[]{"Student", "Subject", "Score", "Total", "Percentage", "Grade", "Date"}, 0);

            PreparedStatement ps = conn.prepareStatement("""
            SELECT *, ROUND((score * 100.0 / NULLIF(total, 0)), 2) as calculated_percentage 
            FROM scores ORDER BY created_at DESC
        """);
            ResultSet rs = ps.executeQuery();

            while (rs.next()) {
                double percentage = rs.getDouble("percentage");
                if (percentage == 0) {
                    percentage = rs.getDouble("calculated_percentage");
                }

                String grade = calculateGrade(percentage);
                String date = "";
                try {
                    Timestamp timestamp = rs.getTimestamp("created_at");
                    if (timestamp != null) {
                        date = timestamp.toString().substring(0, 16);
                    }
                } catch (Exception e) {
                    date = "N/A";
                }

                model.addRow(new Object[]{
                        rs.getString("student"),
                        rs.getString("subject"),
                        rs.getInt("score"),
                        rs.getInt("total"),
                        String.format("%.2f%%", percentage),
                        grade,
                        date
                });
            }

            JTable scoreTable = new JTable(model);
            scoreTable.setFont(new Font("Arial", Font.PLAIN, 12));
            scoreTable.setRowHeight(25);

            JScrollPane scrollPane = new JScrollPane(scoreTable);
            scrollPane.setPreferredSize(new Dimension(800, 400));

            JOptionPane.showMessageDialog(this, scrollPane,
                    "Student Scores - Admin View", JOptionPane.INFORMATION_MESSAGE);

        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error loading scores: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void manageSubjectsDialog() {
        JOptionPane.showMessageDialog(this,
                "Subject management feature will be implemented in the next version.\n" +
                        "Currently all questions are under 'General Quiz' subject.",
                "Manage Subjects", JOptionPane.INFORMATION_MESSAGE);
    }

    private String calculateGrade(double percentage) {
        if (percentage >= 90) return "A+";
        else if (percentage >= 80) return "A";
        else if (percentage >= 70) return "B";
        else if (percentage >= 60) return "C";
        else if (percentage >= 50) return "D";
        else return "F";
    }

    private JPanel createStudentPanel() {
        JPanel p = new JPanel(null);
        p.setBackground(new Color(240, 248, 255));

        JLabel title = new JLabel("STUDENT DASHBOARD");
        title.setFont(new Font("Arial", Font.BOLD, 24));
        title.setBounds(350, 50, 300, 40);
        p.add(title);

        JLabel welcome = new JLabel("Welcome, " + (loggedUser != null ? loggedUser.getUsername() : "Student") + "!");
        welcome.setFont(new Font("Arial", Font.PLAIN, 16));
        welcome.setBounds(350, 100, 300, 30);
        p.add(welcome);

        if (loggedUser instanceof Student) {
            JLabel section = new JLabel("Section: " + ((Student) loggedUser).getSection());
            section.setFont(new Font("Arial", Font.PLAIN, 14));
            section.setBounds(350, 130, 300, 30);
            p.add(section);
        }

        JLabel subjectLabel = new JLabel("Select Subject:");
        subjectLabel.setFont(new Font("Arial", Font.PLAIN, 14));
        subjectLabel.setBounds(300, 180, 100, 30);
        p.add(subjectLabel);

        JComboBox<String> subjectCombo = new JComboBox<>();
        subjectCombo.setBounds(400, 180, 200, 30);
        loadSubjectsToCombo(subjectCombo);
        p.add(subjectCombo);

        JButton startQuiz = new JButton("ðŸŽ¯ START QUIZ");
        startQuiz.setFont(new Font("Arial", Font.BOLD, 16));
        startQuiz.setBounds(350, 230, 200, 50);
        startQuiz.setBackground(new Color(46, 139, 87));
        startQuiz.setForeground(Color.WHITE);
        p.add(startQuiz);

        JButton viewScores = new JButton("ðŸ“Š VIEW MY SCORES");
        viewScores.setFont(new Font("Arial", Font.PLAIN, 14));
        viewScores.setBounds(350, 300, 200, 40);
        viewScores.setBackground(new Color(70, 130, 180));
        viewScores.setForeground(Color.WHITE);

        viewScores.addActionListener(e -> {
            if (loggedUser != null) {
                try {
                    PreparedStatement ps = conn.prepareStatement(
                            "SELECT * FROM scores WHERE student = ? ORDER BY created_at DESC");
                    ps.setString(1, loggedUser.getUsername());
                    ResultSet rs = ps.executeQuery();

                    DefaultTableModel model = new DefaultTableModel(
                            new String[]{"Subject", "Score", "Total", "Percentage", "Grade", "Date"}, 0);

                    boolean hasScores = false;
                    while (rs.next()) {
                        hasScores = true;
                        int score = rs.getInt("score");
                        int total = rs.getInt("total");
                        double percentage = rs.getDouble("percentage");
                        if (percentage == 0 && total > 0) {
                            percentage = (score * 100.0) / total;
                        }
                        String grade = calculateGrade(percentage);
                        String date = "N/A";
                        try {
                            Timestamp timestamp = rs.getTimestamp("created_at");
                            if (timestamp != null) {
                                date = timestamp.toString().substring(0, 16);
                            }
                        } catch (Exception ex) {
                        }

                        model.addRow(new Object[]{
                                rs.getString("subject"),
                                score,
                                total,
                                String.format("%.1f%%", percentage),
                                grade,
                                date
                        });
                    }

                    if (hasScores) {
                        JTable scoreTable = new JTable(model);
                        JScrollPane scrollPane = new JScrollPane(scoreTable);
                        scrollPane.setPreferredSize(new Dimension(500, 300));

                        JOptionPane.showMessageDialog(this, scrollPane,
                                "My Quiz Scores", JOptionPane.INFORMATION_MESSAGE);
                    } else {
                        JOptionPane.showMessageDialog(this,
                                "You haven't taken any quizzes yet!");
                    }

                } catch (Exception ex) {
                    JOptionPane.showMessageDialog(this, "Error loading scores!");
                    ex.printStackTrace();
                }
            }
        });

        p.add(viewScores);

        JButton logout = new JButton("ðŸšª Logout");
        logout.setBounds(700, 20, 150, 30);
        logout.setBackground(new Color(105, 105, 105));
        logout.setForeground(Color.WHITE);
        logout.addActionListener(e -> {
            loggedUser = null;
            card.show(mainPanel, "login");
        });
        p.add(logout);

        JButton exit = new JButton("âŒ Exit System");
        exit.setBounds(700, 60, 150, 30);
        exit.setBackground(new Color(220, 20, 60));
        exit.setForeground(Color.WHITE);
        exit.addActionListener(e -> System.exit(0));
        p.add(exit);

        startQuiz.addActionListener(e -> {
            String selectedSubject = (String) subjectCombo.getSelectedItem();
            if (selectedSubject != null && !selectedSubject.toString().isEmpty()) {
                currentSubject = selectedSubject.toString();
                startQuizWithSubject(currentSubject);
            } else {
                JOptionPane.showMessageDialog(this, "Please select a subject!");
            }
        });

        return p;
    }

    private void loadSubjectsToCombo(JComboBox<String> combo) {
        try {
            combo.removeAllItems();
            combo.addItem("General Quiz");

            try {
                PreparedStatement ps = conn.prepareStatement(
                        "SELECT name FROM subjects ORDER BY name");
                ResultSet rs = ps.executeQuery();

                while (rs.next()) {
                    combo.addItem(rs.getString("name"));
                }
            } catch (Exception e) {
                System.out.println("Note: Subjects table not available yet");
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private JPanel createQuizPanel() {
        JPanel p = new JPanel(null);
        p.setBackground(new Color(255, 250, 240));

        timerLabel = new JLabel("Time: 60");
        timerLabel.setFont(new Font("Arial", Font.BOLD, 18));
        timerLabel.setForeground(Color.RED);
        timerLabel.setBounds(700, 20, 150, 30);
        p.add(timerLabel);

        JLabel qNumber = new JLabel("Question:");
        qNumber.setFont(new Font("Arial", Font.PLAIN, 14));
        qNumber.setBounds(20, 20, 100, 30);
        p.add(qNumber);

        qText = new JLabel();
        qText.setFont(new Font("Arial", Font.PLAIN, 16));
        qText.setBounds(20, 60, 800, 40);
        p.add(qText);

        optA = new JRadioButton();
        optB = new JRadioButton();
        optC = new JRadioButton();
        optD = new JRadioButton();

        Font optionFont = new Font("Arial", Font.PLAIN, 14);
        optA.setFont(optionFont);
        optB.setFont(optionFont);
        optC.setFont(optionFont);
        optD.setFont(optionFont);

        optA.setBackground(new Color(255, 250, 240));
        optB.setBackground(new Color(255, 250, 240));
        optC.setBackground(new Color(255, 250, 240));
        optD.setBackground(new Color(255, 250, 240));

        group = new ButtonGroup();
        group.add(optA);
        group.add(optB);
        group.add(optC);
        group.add(optD);

        optA.setBounds(40, 120, 600, 30);
        optB.setBounds(40, 160, 600, 30);
        optC.setBounds(40, 200, 600, 30);
        optD.setBounds(40, 240, 600, 30);

        p.add(optA); p.add(optB); p.add(optC); p.add(optD);

        JButton nextBtn = new JButton("Next âž¡");
        nextBtn.setBounds(700, 500, 150, 40);
        nextBtn.addActionListener(e -> nextQuestion());
        p.add(nextBtn);

        return p;
    }

    private void startQuizWithSubject(String subject) {
        if (quizTimer != null && quizTimer.isRunning()) {
            quizTimer.stop();
        }

        quizQuestions = new ArrayList<>();
        score = 0;
        totalPoints = 0;
        currentIndex = 0;

        currentSubject = subject;

        try {
            System.out.println("Starting " + currentSubject + " quiz...");

            ResultSet rs = conn.createStatement().executeQuery("SELECT * FROM questions");

            int count = 0;
            while (rs.next()) {
                count++;
                Question q = new Question();
                q.id = rs.getInt("id");
                q.question = rs.getString("question");
                q.a = rs.getString("choiceA");
                q.b = rs.getString("choiceB");
                q.c = rs.getString("choiceC");
                q.d = rs.getString("choiceD");
                q.correct = rs.getString("correct");
                q.type = rs.getString("type");
                q.points = rs.getInt("points");
                quizQuestions.add(q);
            }
            System.out.println("âœ“ Loaded " + count + " questions");

        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error loading questions: " + e.getMessage());
            e.printStackTrace();
            return;
        }

        if (quizQuestions.isEmpty()) {
            JOptionPane.showMessageDialog(this, "No questions available for " + currentSubject + "!");
            return;
        }

        Collections.shuffle(quizQuestions);
        startTimer();
        loadQuestion();
        card.show(mainPanel, "quiz");
    }

    private void startTimer() {
        timeLeft = 60;
        quizTimer = new Timer(1000, e -> {
            timeLeft--;
            timerLabel.setText("Time: " + timeLeft);
            timerLabel.setForeground(timeLeft <= 10 ? Color.RED : Color.BLACK);

            if (timeLeft <= 0) {
                quizTimer.stop();
                nextQuestion();
            }
        });
        quizTimer.start();
    }

    private void loadQuestion() {
        if (currentIndex >= quizQuestions.size()) {
            finishQuiz();
            return;
        }

        Question q = quizQuestions.get(currentIndex);

        qText.setText("<html><b>Q" + (currentIndex + 1) + ":</b> " + q.question + "</html>");

        optA.setText("A. " + q.a);
        optB.setText("B. " + q.b);
        optC.setText("C. " + q.c);
        optD.setText("D. " + q.d);

        group.clearSelection();

        timerLabel.setText("Time: " + timeLeft);
    }

    private void nextQuestion() {
        if (currentIndex < quizQuestions.size()) {
            Question q = quizQuestions.get(currentIndex);

            String ans = "";
            if (optA.isSelected()) ans = "A";
            else if (optB.isSelected()) ans = "B";
            else if (optC.isSelected()) ans = "C";
            else if (optD.isSelected()) ans = "D";

            if (ans.equalsIgnoreCase(q.correct)) {
                score += q.points;
            }
            totalPoints += q.points;

            currentIndex++;

            if (currentIndex < quizQuestions.size()) {
                loadQuestion();
            } else {
                finishQuiz();
            }
        }
    }

    private void finishQuiz() {
        if (quizTimer != null && quizTimer.isRunning()) {
            quizTimer.stop();
        }

        double percentage = totalPoints > 0 ? (score * 100.0 / totalPoints) : 0;
        String grade = calculateGrade(percentage);

        String resultMessage = String.format("""
            <html><div style='font-size:14px;'>
            <b>QUIZ COMPLETED!</b><br><br>
            Subject: <b>%s</b><br>
            Score: <b>%d / %d</b><br>
            Percentage: <b>%.1f%%</b><br>
            Grade: <b>%s</b><br>
            Time Taken: <b>%d seconds</b><br><br>
            """, currentSubject, score, totalPoints, percentage, grade, (60 - timeLeft));

        if (percentage >= 60) {
            resultMessage += "<font color='green'>ðŸŽ‰ Congratulations! You passed!</font>";
        } else {
            resultMessage += "<font color='red'>ðŸ“š Better luck next time!</font>";
        }
        resultMessage += "</div></html>";

        JOptionPane.showMessageDialog(this, resultMessage, "Quiz Results",
                JOptionPane.INFORMATION_MESSAGE);

        saveScore(score, totalPoints, currentSubject);

        card.show(mainPanel, "student");
    }

    private void saveScore(int score, int total, String subject) {
        try {
            double percentage = total > 0 ? (score * 100.0 / total) : 0;
            String grade = calculateGrade(percentage);

            PreparedStatement ps = conn.prepareStatement("""
            INSERT INTO scores(student, subject, score, total, percentage, grade, time_taken)
            VALUES(?, ?, ?, ?, ?, ?, ?)
        """);

            String studentName = loggedUser != null ? loggedUser.getUsername() : "Unknown";

            ps.setString(1, studentName);
            ps.setString(2, subject);
            ps.setInt(3, score);
            ps.setInt(4, total);
            ps.setDouble(5, percentage);
            ps.setString(6, grade);
            ps.setInt(7, 60 - timeLeft);

            ps.executeUpdate();

            System.out.println("Score saved for " + studentName +
                    " in " + subject + ": " + score + "/" + total +
                    " (" + String.format("%.1f%%", percentage) + ")");

        } catch (Exception e) {
            System.err.println("Error saving score: " + e.getMessage());
            e.printStackTrace();
        }
    }
}